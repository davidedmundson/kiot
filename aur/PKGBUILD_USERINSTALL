# Maintainer: Your Name <your@email.com>
# User-install version of kiot that installs to $HOME/.local without sudo

_pkgbase=kiot
pkgname=kiot-user-git
pkgver=r104.1b51625
pkgrel=1
pkgdesc="A background daemon that exposes information and actions of the KDE Plasma session to a home automation controller like Home Assistant (user installation)"
arch=(x86_64)
url="https://github.com/davidedmundson/kiot"
license=(MIT)
depends=(qt6-base qt6-declarative qt6-mqtt
         kconfig kcoreaddons kdbusaddons knotifications kidletime
         kglobalaccel kcmutils ki18n solid bluez-qt pulseaudio-qt
         systemd-libs)
makedepends=(cmake extra-cmake-modules git)
provides=(kiot)
conflicts=(kiot kiot-git)
source=("git+$url.git")
md5sums=('SKIP')

pkgver() {
    cd "$srcdir/$_pkgbase"
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
}

build() {
    cd "$srcdir/$_pkgbase"
    
    # Clean build directory
    rm -rf build
    mkdir -p build
    
    cd build
    
    # Configure for user installation
    local cmake_options=(
        -DCMAKE_INSTALL_PREFIX="$HOME/.local"
        -DCMAKE_BUILD_TYPE=Release
        -Wno-dev
    )
    
    cmake "${cmake_options[@]}" ..
    cmake --build . -j$(nproc)
}

package() {
    cd "$srcdir/$_pkgbase/build"
    
    # Install to package directory first
    DESTDIR="$pkgdir" cmake --install .
    
    # Create post-install script
    mkdir -p "$pkgdir/$HOME/.local/bin"
    cat > "$pkgdir/$HOME/.local/bin/kiot-update" << 'EOF'
#!/bin/bash
# Kiot user package updater
# This script updates kiot user installation

set -e

echo "Updating kiot user installation..."
cd "$(dirname "$0")/../.."

# Check if we're in the right directory
if [ ! -f "PKGBUILD_USERINSTALL" ]; then
    echo "Error: PKGBUILD_USERINSTALL not found in current directory"
    exit 1
fi

# Build and install
if makepkg -si --noconfirm --nodeps; then
    echo "Kiot updated successfully!"
    echo "Restart kiot with: systemctl --user restart kiot"
else
    echo "Update failed!"
    exit 1
fi
EOF
    
    chmod +x "$pkgdir/$HOME/.local/bin/kiot-update"
    
    # Create desktop file with correct paths
    if [ -f "$pkgdir/$HOME/.local/share/applications/org.davidedmundson.kiot.desktop" ]; then
        sed -i "s|^Exec=.*|Exec=$HOME/.local/bin/kiot|" \
            "$pkgdir/$HOME/.local/share/applications/org.davidedmundson.kiot.desktop"
    fi
}

post_install() {
    echo ""
    echo "=========================================="
    echo "Kiot user installation complete!"
    echo "=========================================="
    echo ""
    echo "Files installed to: $HOME/.local/"
    echo "  - Binary: $HOME/.local/bin/kiot"
    echo "  - Config: $HOME/.local/share/kiot/"
    echo "  - Desktop file: $HOME/.local/share/applications/org.davidedmundson.kiot.desktop"
    echo ""
    echo "To run kiot:"
    echo "  $HOME/.local/bin/kiot"
    echo ""
    echo "To update kiot later:"
    echo "  $HOME/.local/bin/kiot-update"
    echo ""
    echo "To enable auto-start:"
    echo "  systemctl --user enable --now kiot"
    echo ""
    echo "Note: Make sure $HOME/.local/bin is in your PATH"
    echo "=========================================="
}

post_upgrade() {
    post_install
}

post_remove() {
    echo ""
    echo "Kiot user installation removed."
    echo "You may want to manually remove:"
    echo "  - $HOME/.local/bin/kiot"
    echo "  - $HOME/.local/bin/kiot-update"
    echo "  - $HOME/.local/share/kiot/"
    echo "  - $HOME/.local/share/applications/org.davidedmundson.kiot.desktop"
    echo "  - $HOME/.config/systemd/user/kiot.service"
    echo ""
}